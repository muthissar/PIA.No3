<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
<body>
{% set curves = [] %}
{% for curve_id in range(n_curves) %}
{% do curves.append("curve/" ~ curve_id) %}
{% endfor %}
{% set time_cursable = ["piano_roll"] + curves %}
{% for curve in time_cursable %}
    <div id="{{curve}}"></div>
{% endfor %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!-- <input type="text" id="myTextField" value="Initial text"> -->
<audio controls="True" ontimeupdate="animate_curves(this)" src="http://localhost:8000/audio" type="audio/mpeg" >
    <script>
        // var textField = document.getElementById('myTextField');
        // function myScript(e) {
        //     // var x = document.getElementById("myAudio");
        //     // x.currentTime = 0;
        //     // x.play();
        //     textField.value = e.currentTime;
        // }
        let time_cursable = {{time_cursable|tojson}};
        function animate_curves(e) {
            // prog = e.currentTime/e.duration * 5;
            prog = e.currentTime;
            time_cursable.forEach(function(curve){
                Plotly.animate(curve, {
                    data: [{x: [prog, prog]}],
                    traces: [1],
                    layout: {}
                }, 
                {
                    transition: {
                    duration: 0,
                    easing: 'cubic-in-out'
                    },
                    frame: {
                    duration: 0
                    }
                });
            })
            {# {% endfor %} #}
        }
    </script>
</audio>
<script>
// Fetch the JSON data
{# for (let i = 0; i < {{n_curves}}; i++) { #}
{{time_cursable|tojson}}.forEach(function(curve) {
    fetch(`http://localhost:8000/${curve}`)
  .then(response => response.json())
  .then(plotly_fig => {
    // Use Plotly to plot the data
    data_plot = plotly_fig.data[0];
    if (data_plot['type'] == 'heatmap'){
        ys = [0, data_plot.z.length]
        plotly_fig.data = [data_plot]
    }
    else {
        ys = [Math.min(...data_plot.y), Math.max(...data_plot.y)]
    }
    xs = [Math.min(...data_plot.x), Math.min(...data_plot.x)]
    var trace1 = {
        x: xs,
        y: ys,
        mode: 'lines+markers',
        type: 'scatter',
        name: 'Trace 1',
    };
    plotly_fig.data.push(trace1)
    plotly_fig.layout['showlegend'] = false;
    Plotly.react(`${curve}`, plotly_fig);
  })
  .catch(
    error => console.error('Error:', error)
    );
})
</script>
<form id="choose-form">
  <select name="choice">
    {% for curve_id in range(n_curves) %}
        <option value={{curve_id}}>{{curve_id}}</option>
    {% endfor %}
  </select>
  <input type="submit" value="Submit">
</form>
<div id="successAlert" class="alert alert-success" role="alert" style="display: none;">
  Success! Your form was submitted.
</div>
<div id="failAlert" class="alert alert-danger" role="alert" style="display: none;">
  Fail! Your form was submitted.
</div>
<script>
document.getElementById('choose-form').addEventListener('submit', function(event) {
  event.preventDefault();  // Prevent the form from submitting normally

  {# var inputValue =  document.getElementById('choose-form').choice.value; #}
  var form =  document.getElementById('choose-form')
  fetch('http://localhost:8000/choose', {
    method: 'POST',
    body: new FormData(form)
    {# body: JSON.stringify({ choice: inputValue }) #}
    {# body: url.encode({ choice: inputValue }) #}
  })
  .then(response => response.json())
  .then(data => {
    if (data.success){
      document.getElementById('successAlert').style.display = 'block';
    }
    else {
      document.getElementById('failAlert').style.display = 'block';
    }
  })
  .catch((error) => {
    console.error('Error:', error);
  });
});
</script>
{% block debug %}{% endblock %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>